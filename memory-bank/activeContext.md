# Active Context

## Current Work Focus

* **마크다운 목차 기능 완성**: Safari 호환성 문제를 해결하고 계층적 목차 네비게이션 기능을 완전 구현 (2025-07-20)
* **Safari 브라우저 호환성 확보**: 라이브러리 로딩 대기 시스템과 DOM 요소 null 체크로 안정성 향상
* **PDF.js 기본 파일 로딩 오류 해결**: compressed.tracemonkey-pldi-09.pdf 로딩 오류 제거로 깔끔한 사용자 경험 제공

## Recent Changes

* **Universal Viewer 아키텍처 완전 전환** (2025-07-19)
  - PDF.js 공식 viewer.html을 기반으로 새로운 index.html 생성
  - Markdown 파일 지원 기능을 PDF.js 뷰어에 통합 (툴바에 "📝 Markdown 열기" 버튼 추가)
  - marked.js, Mermaid.js, Prism.js, KaTeX 등 모든 기존 라이브러리 유지
  - 기존 index.html을 old.index.html로 백업하고 universal-viewer.html을 새로운 index.html로 설정
  - vendor/web/ 및 vendor/build/ 경로 문제 해결로 모든 아이콘과 리소스 정상 로드 확인

* **PDF 텍스트 선택 문제 근본 해결**: 커스텀 텍스트 레이어 대신 PDF.js 표준 뷰어의 완성된 텍스트 선택 기능 활용

* **Todo 관리 및 기능 계획 수립** (2025-07-19)
  - 외부 저장소 및 사용자 계정이 불필요한 기능들을 우선적으로 선별
  - 문서 내 검색, 다크모드, 전체화면 모드 등 17개 기능을 우선순위별로 분류
  - Memory Bank의 progress.md에 구조화된 형태로 저장하여 세션 간 연속성 확보
  - PDF 페이지 썸네일 기능은 사용자 요청에 따라 제외

* **에러 메시지 팝업 닫기 버튼 버그 수정** (2025-07-16)
  - `js/ui.js`에서 에러 메시지의 '확인' 버튼에 대한 이벤트 리스너 등록 방식을 리팩터링하여 Safari 등 다양한 브라우저와의 호환성을 확보.
  - `index.html`에서 정적 `onclick` 핸들러를 제거하고, `js/ui.js`에서 동적으로 이벤트 리스너를 추가하는 방식으로 변경.
  - `js/app.js`에서 새로운 에러를 표시하거나 사용자가 URL을 입력하기 시작할 때 기존 에러 메시지를 자동으로 숨기는 로직을 추가하여 사용자 경험을 개선.

* **KaTeX 블록 수식 렌더링 로직 개선** (2025-06-22)
  - js/markdown-viewer.js에서 marked.js가 생성하는 다양한 HTML 패턴(<p>$$<br>수식<br>$$</p>, $$<br>수식<br>$$, $$\n수식\n$$ 등)에 대응하는 정규식 치환 로직 추가.
  - Mermaid, Prism 등 기존 렌더링 로직과의 충돌 없이 수식이 올바르게 표시됨을 확인.
  - sample.md 등 테스트 문서에서 블록 수식, 인라인 수식 모두 정상 렌더링 확인.

* **Mermaid 렌더링 로직 개선** (2025-06-22)
  - `processMermaidDiagrams` 함수에서 `textarea`를 이용한 HTML 엔티티 디코딩 방식에 `<br>` 태그를 개행 문자로 치환하는 로직을 추가하여, `sequenceDiagram` 및 `graph TD` 등 복잡한 다이어그램의 렌더링 오류 해결.

* **`app.js` 리팩터링 및 모듈 분리** (2025-06-22)
  - `app.js`에 혼재되어 있던 Markdown 관련 기능(파싱, 렌더링, 목차 생성 등)을 `js/markdown-viewer.js` 모듈로 분리.
  - `app.js`는 이제 각 뷰어 모듈을 호출하고 전체적인 흐름을 제어하는 역할에 집중.
  - `js/ui.js`와 `js/pdf-viewer.js`의 전역 변수 의존성을 제거하고, 함수 인자를 통해 데이터를 전달하도록 수정.
  - `index.html`의 스크립트 로드 방식을 ES6 모듈 타입에 맞게 수정.

* **테스트 스위트 개선** (2025-06-22)
  - 신규 `tests/markdown-viewer.test.js` 파일을 생성하여 분리된 Markdown 뷰어 모듈의 기능을 검증.
  - 기존 `tests/app.test.js`와 `tests/pdf-viewer.test.js`를 리팩터링된 코드 구조에 맞게 수정.
  - `tests/setupTests.js`에 `marked`, `mermaid`, `fetch` API 및 DOM 함수의 모의 구현을 추가하여 테스트 안정성 확보.
  - 모든 테스트가 성공적으로 통과하는 것을 확인.

* **PDF 텍스트 선택 문제 분석 및 디버깅 강화** (2025-01-21)
  - 텍스트 요소에 명시적 너비 설정: PDF.js의 textItem.width를 활용하여 정확한 너비 계산
  - 3가지 방법으로 텍스트 너비 계산: 폰트 크기 비례, Transform matrix 기반, 직접 스케일 계산
  - 컨테이너 크기 0 문제 해결을 위한 CSS 스타일 강제 적용
  - 상세한 디버깅 로그 추가: 렌더링 전후 컨테이너 크기, POST-SCALE VERIFICATION

* **렌더링 시점 최적화**
  - DOM 레이아웃 완료 대기: requestAnimationFrame 및 setTimeout 활용
  - 캔버스 렌더링 후 50ms 지연을 두고 텍스트 레이어 렌더링
  - 컨테이너 크기 강제 설정으로 크기 0 문제 해결 시도

* **이전 해결 완료 항목들**
  - PDF 페이지 간 크기 불일치 문제 **해결됨** (100% 고정 줌에서 모든 페이지 크기가 일관적으로 유지됨)
  - PDF 기본 줌 설정 100% 적용 및 스케일링 로직 안정화

## Next Steps

### 우선순위: 높음 (즉시 시작 가능)
* **다크모드 기능 구현**: CSS 변수 기반 테마 전환 시스템 구축
* **전체화면 모드 구현**: 몰입 읽기를 위한 전체화면 뷰어 모드
* **진행률 표시 기능**: 문서 읽기 진행 상황 시각화

### 우선순위: 보통 (단기)
* **기존 커스텀 뷰어 기능 통합**: old.index.html의 문서 비교 기능을 새로운 Universal Viewer에 통합
* **PDF 목차 자동 생성**: PDF 북마크 추출 및 네비게이션 기능
* **향상된 Markdown 기능**: 새로운 뷰어에서 목차 사이드바, 스크롤 동기화 등 추가

### 완료된 이슈
* **PDF 텍스트 선택 위치 불일치 문제 해결**: ✅ PDF.js 표준 뷰어 도입으로 근본 해결됨
* **Universal Viewer 아키텍처 구현**: ✅ 완료 - PDF와 Markdown을 하나의 인터페이스에서 지원

## Active Decisions and Considerations

* **PDF.js 표준 뷰어 채택**: 커스텀 구현 대신 완성도 높은 공식 뷰어를 기반으로 하여 안정성과 기능 완성도 확보
* **Markdown 통합 접근**: PDF 뷰어에 Markdown 지원을 추가하여 하나의 인터페이스에서 모든 문서 형식 지원
* **점진적 기능 마이그레이션**: 기존 커스텀 뷰어의 장점(문서 비교, 드래그앤드롭 등)을 새로운 Universal Viewer에 단계적 통합
* **사용자 계정 불필요 기능 우선**: 외부 저장소나 사용자 계정이 필요하지 않은 기능들을 우선적으로 개발하여 배포 복잡성을 최소화
* **Memory Bank 기반 작업 관리**: 세션 간 연속성을 위해 Todo 리스트와 진행 상황을 Memory Bank에 체계적으로 문서화
* **URL 로딩 에러 처리 우선**: HEAD 요청을 통한 선제적 에러 감지로 사용자 경험 향상
* **구체적 에러 메시지 제공**: CORS, HTTP 상태코드별 맞춤형 안내로 사용자 이해도 향상
* **텍스트 너비 정확성 우선**: 3가지 계산 방법 중 최대값 사용으로 선택 영역 부족 문제 방지
* **디버깅 우선 접근**: 상세한 로그를 통해 실제 렌더링 상태 파악 후 정밀 조정
* **DOM 레이아웃 타이밍 최적화**: 컨테이너 크기 0 문제 해결을 위한 다층적 접근
* **100% 기본 줌 유지**: 사용자가 요청한 100% 기본값으로 예측 가능한 크기 제공

## Important Patterns and Preferences

* **표준 기반 아키텍처**: 검증된 오픈소스 솔루션(PDF.js)을 기반으로 확장하여 안정성과 호환성 확보
* **통합 인터페이스 선호**: 여러 도구를 전환하지 않고 하나의 인터페이스에서 모든 작업을 수행할 수 있는 환경 구축
* **점진적 마이그레이션**: 기존 기능을 유지하면서 새로운 아키텍처로 단계적 전환하여 사용자 불편 최소화
* **우선순위 기반 개발**: 사용자에게 즉시 가치를 제공할 수 있는 기능을 우선적으로 개발하여 프로젝트의 실용성을 높임
* **외부 의존성 최소화**: 사용자 계정, 외부 저장소 등 복잡한 의존성을 피하고 브라우저 내에서 완결되는 기능을 선호
* **Memory Bank 활용**: 프로젝트 컨텍스트와 진행 상황을 체계적으로 문서화하여 세션 간 연속성 확보
* **관심사 분리(SoC)**: 기능별로 코드를 모듈화하는 것이 장기적인 유지보수성과 확장성에 매우 중요함을 재확인.
* **테스트 주도 리팩터링**: 기존 테스트 코드가 리팩터링 과정에서 회귀(regression)를 방지하는 안전망 역할을 했으며, 새로운 테스트 코드는 변경된 구조의 안정성을 보장함.
* **JSDOM의 한계 인지**: `getBoundingClientRect`와 같이 실제 렌더링에 의존하는 DOM API는 JSDOM에서 완벽하게 동작하지 않으므로, 테스트 환경에서 적절한 모의(mock) 처리가 필수적임.
* **모듈 스코프 이해**: ES6 모듈을 사용하면 변수와 함수는 기본적으로 해당 모듈 내에서만 유효함. 모듈 간 데이터 공유는 `export`와 `import`를 통해 명시적으로 이루어져야 함.
* **HTML 엔티티 디코딩의 함정**: `textarea`를 이용한 디코딩은 간편하지만, `<br>`과 같은 특정 태그가 의도치 않게 변환될 수 있으므로, 예외 케이스를 고려한 추가 처리가 필요함을 학습.
