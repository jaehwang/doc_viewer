# Active Context

## Current Work Focus

* **KaTeX(LaTeX 수식) 블록 수식 렌더링 개선**: js/markdown-viewer.js에서 다양한 마크다운-HTML 변환 케이스(특히 $$ ... $$ 블록 수식이 <p>, <br>, \n 등으로 감싸지는 경우)를 모두 치환하도록 정규식 로직을 대폭 개선. 인라인($...$)과 블록($$...$$) 수식 모두 Markdown 뷰어에서 정상적으로 렌더링되도록 구현.

## Recent Changes

* **KaTeX 블록 수식 렌더링 로직 개선** (2025-06-22)
  - js/markdown-viewer.js에서 marked.js가 생성하는 다양한 HTML 패턴(<p>$$<br>수식<br>$$</p>, $$<br>수식<br>$$, $$\n수식\n$$ 등)에 대응하는 정규식 치환 로직 추가.
  - Mermaid, Prism 등 기존 렌더링 로직과의 충돌 없이 수식이 올바르게 표시됨을 확인.
  - sample.md 등 테스트 문서에서 블록 수식, 인라인 수식 모두 정상 렌더링 확인.

* **Mermaid 렌더링 로직 개선** (2025-06-22)
  - `processMermaidDiagrams` 함수에서 `textarea`를 이용한 HTML 엔티티 디코딩 방식에 `<br>` 태그를 개행 문자로 치환하는 로직을 추가하여, `sequenceDiagram` 및 `graph TD` 등 복잡한 다이어그램의 렌더링 오류 해결.

* **`app.js` 리팩터링 및 모듈 분리** (2025-06-22)
  - `app.js`에 혼재되어 있던 Markdown 관련 기능(파싱, 렌더링, 목차 생성 등)을 `js/markdown-viewer.js` 모듈로 분리.
  - `app.js`는 이제 각 뷰어 모듈을 호출하고 전체적인 흐름을 제어하는 역할에 집중.
  - `js/ui.js`와 `js/pdf-viewer.js`의 전역 변수 의존성을 제거하고, 함수 인자를 통해 데이터를 전달하도록 수정.
  - `index.html`의 스크립트 로드 방식을 ES6 모듈 타입에 맞게 수정.

* **테스트 스위트 개선** (2025-06-22)
  - 신규 `tests/markdown-viewer.test.js` 파일을 생성하여 분리된 Markdown 뷰어 모듈의 기능을 검증.
  - 기존 `tests/app.test.js`와 `tests/pdf-viewer.test.js`를 리팩터링된 코드 구조에 맞게 수정.
  - `tests/setupTests.js`에 `marked`, `mermaid`, `fetch` API 및 DOM 함수의 모의 구현을 추가하여 테스트 안정성 확보.
  - 모든 테스트가 성공적으로 통과하는 것을 확인.

* **PDF 텍스트 선택 문제 분석 및 디버깅 강화** (2025-01-21)
  - 텍스트 요소에 명시적 너비 설정: PDF.js의 textItem.width를 활용하여 정확한 너비 계산
  - 3가지 방법으로 텍스트 너비 계산: 폰트 크기 비례, Transform matrix 기반, 직접 스케일 계산
  - 컨테이너 크기 0 문제 해결을 위한 CSS 스타일 강제 적용
  - 상세한 디버깅 로그 추가: 렌더링 전후 컨테이너 크기, POST-SCALE VERIFICATION

* **렌더링 시점 최적화**
  - DOM 레이아웃 완료 대기: requestAnimationFrame 및 setTimeout 활용
  - 캔버스 렌더링 후 50ms 지연을 두고 텍스트 레이어 렌더링
  - 컨테이너 크기 강제 설정으로 크기 0 문제 해결 시도

* **이전 해결 완료 항목들**
  - PDF 페이지 간 크기 불일치 문제 **해결됨** (100% 고정 줌에서 모든 페이지 크기가 일관적으로 유지됨)
  - PDF 기본 줌 설정 100% 적용 및 스케일링 로직 안정화

## Next Steps

* **PDF 텍스트 선택 위치 불일치 문제 해결**: 현재 가장 시급한 버그로, 선택 영역의 오른쪽 끝이 텍스트와 일치하지 않는 문제를 해결해야 함.
* **문서 비교 기능 리팩터링**: 현재 `app.js`에 남아있는 문서 비교 로직을 `js/diff-viewer.js` 모듈로 분리하는 작업 검토.
* **URL 로딩 기능 추가 개선**: 로딩 진행률 표시, UI/UX 개선 등.

## Active Decisions and Considerations

* **URL 로딩 에러 처리 우선**: HEAD 요청을 통한 선제적 에러 감지로 사용자 경험 향상
* **구체적 에러 메시지 제공**: CORS, HTTP 상태코드별 맞춤형 안내로 사용자 이해도 향상
* **텍스트 너비 정확성 우선**: 3가지 계산 방법 중 최대값 사용으로 선택 영역 부족 문제 방지
* **디버깅 우선 접근**: 상세한 로그를 통해 실제 렌더링 상태 파악 후 정밀 조정
* **DOM 레이아웃 타이밍 최적화**: 컨테이너 크기 0 문제 해결을 위한 다층적 접근
* **100% 기본 줌 유지**: 사용자가 요청한 100% 기본값으로 예측 가능한 크기 제공

## Important Patterns and Preferences

* **관심사 분리(SoC)**: 기능별로 코드를 모듈화하는 것이 장기적인 유지보수성과 확장성에 매우 중요함을 재확인.
* **테스트 주도 리팩터링**: 기존 테스트 코드가 리팩터링 과정에서 회귀(regression)를 방지하는 안전망 역할을 했으며, 새로운 테스트 코드는 변경된 구조의 안정성을 보장함.
* **JSDOM의 한계 인지**: `getBoundingClientRect`와 같이 실제 렌더링에 의존하는 DOM API는 JSDOM에서 완벽하게 동작하지 않으므로, 테스트 환경에서 적절한 모의(mock) 처리가 필수적임.
* **모듈 스코프 이해**: ES6 모듈을 사용하면 변수와 함수는 기본적으로 해당 모듈 내에서만 유효함. 모듈 간 데이터 공유는 `export`와 `import`를 통해 명시적으로 이루어져야 함.
* **HTML 엔티티 디코딩의 함정**: `textarea`를 이용한 디코딩은 간편하지만, `<br>`과 같은 특정 태그가 의도치 않게 변환될 수 있으므로, 예외 케이스를 고려한 추가 처리가 필요함을 학습.
